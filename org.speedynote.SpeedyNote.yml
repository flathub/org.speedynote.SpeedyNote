# SpeedyNote Flatpak Manifest
# Build locally:  flatpak-builder --force-clean build-dir flatpak/org.speedynote.SpeedyNote.yml
# Install locally: flatpak-builder --user --install --force-clean build-dir flatpak/org.speedynote.SpeedyNote.yml
# Run:             flatpak run org.speedynote.SpeedyNote

app-id: org.speedynote.SpeedyNote
runtime: org.kde.Platform
runtime-version: '6.10'
sdk: org.kde.Sdk
command: speedynote

finish-args:
  # Display (Wayland preferred, X11 fallback)
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  # GPU rendering
  - --device=dri
  # Access ~/Documents for notebook storage and PDF files.
  # Other locations are accessible via the file chooser portal.
  - --filesystem=xdg-documents
cleanup:
  - /include
modules:
  # =========================================================================
  # MuPDF - PDF rendering and export library
  # =========================================================================
  # Built as a shared library. Uses runtime-provided libraries where available;
  # bundles only libraries not present in the KDE runtime.
  # SpeedyNote uses MuPDF exclusively for all PDF operations.
  - name: mupdf
    buildsystem: simple
    build-commands:
      - |-
        make \
          HAVE_X11=no \
          HAVE_GLUT=no \
          HAVE_CURL=no \
          HAVE_OBJCOPY=no \
          USE_SYSTEM_FREETYPE=yes \
          USE_SYSTEM_HARFBUZZ=yes \
          USE_SYSTEM_LIBJPEG=yes \
          USE_SYSTEM_ZLIB=yes \
          USE_SYSTEM_OPENJPEG=yes \
          USE_SYSTEM_JBIG2DEC=no \
          USE_SYSTEM_LCMS2=yes \
          USE_SYSTEM_MUJS=no \
          USE_SYSTEM_GUMBO=no \
          USE_SYSTEM_LEPTONICA=no \
          USE_SYSTEM_TESSERACT=no \
          shared=yes \
          build=release \
          libs \
          -j${FLATPAK_BUILDER_N_JOBS}
      - install -d /app/lib /app/include
      - cp -a build/shared-release/libmupdf.so* /app/lib/
      - cp -r include/mupdf /app/include/
    sources:
      - type: archive
        url: https://mupdf.com/downloads/archive/mupdf-1.25.1-source.tar.gz
        sha256: 81aa1361252418cc45347b4ac075532096957a7ab772e20e046f3bb418d7263c

  # =========================================================================
  # SpeedyNote - main application
  # =========================================================================
  - name: speedynote
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DMUPDF_INCLUDE_DIR=/app/include
    sources:
      - type: archive
        url: https://github.com/alpha-liu-01/SpeedyNote/archive/refs/tags/v1.2.4.tar.gz
        sha256: 301a8f71093611735dad38037368f32dfcc08aaf8270e391bc633b6de581160b

